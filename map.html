<!DOCTYPE html>
<html>
<head>
  <title>Basic Map</title>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js" type="text/javascript"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.13&key=AIzaSyCK8hjB2uGNwQ7sklSL6r0epuowX_ku4CI&sensor=false" type="text/javascript"></script>
  <script src="http://track.geocoding.io/socket.io/socket.io.js" type="text/javascript"></script>
  <style type="text/css">
    html{ height: 100% }
    body{ height: 100%; margin:0; padding: 0;}
    #mapdiv{ width: 60%; height: 100%; float:left; }
    #messages{ width: 40%; float: left; font-size: x-small;}
  </style>
</head>
<body>
  <div id="mapdiv"></div>

  <div id="messages">
    GPS<br/>
  </div>

  <script language="JavaScript">
    var map, socket;
    var devices = [], marker;

    function initMap(){
      //var myLatlng = new google.maps.LatLng(-25.363882,131.044922); //Australia
      var myLatlng = new google.maps.LatLng(0,0);

      var mapOptions = {
        center: myLatlng,
        zoom: 10
      };

      map = new google.maps.Map(document.getElementById('mapdiv'), mapOptions);
    }

    function getDevice(device_id, markers){
      var device = null;

      for(var i = 0; i < markers.length; i++){
        if(markers[i].device_id === device_id){
          device = markers[i];
          break;
        }
      }

      return device;
    }

    function processGPS(gps){
      var device = getDevice(gps.device_id, devices);
      if(device == null){
        device = createDevice(gps);
        devices.push(device);
      }
      else{
        moveDevice(device, gps);
      }
    }

    function createDevice(gps){
      var pos = getLatLngFromString(gps);
      var marker = new google.maps.Marker({
        position: pos,
        map: map
      });

      marker.set("device_id", gps.device_id);
      return marker;
    }

    function moveDevice(device, gps){
      var pos = getLatLngFromString(gps);
      device.setPosition(pos);
    }

    function getLatLngFromString(obj){
      var lat = parseFloat(obj.gps_latitude), lon = parseFloat(obj.gps_longitude);
      return new google.maps.LatLng(lat, lon);
    }

    function formatGPSHTMLOutput(gps){
      var s = gps.device_id + ' ';
      s += gps.gps_timestamp + ' ';
      s += '(' + gps.gps_latitude + ',' + gps.gps_longitude + ')';
      s += '<br/>';
      return s;
    }

    function initSocket(){
      var host = "track.geocoding.io";
      var port = 8080;

      socket = io.connect('http://' + host + ':' + port);

      socket.on('message', function(d){
        var parsedObj = JSON.parse(d);
        if(parsedObj.type === 'gps'){
          var gps = parsedObj.data;
          $('#messages').append(formatGPSHTMLOutput(gps));
          processGPS(gps);
        }
      });
    }

    $(document).ready(function(){
      initMap();
      initSocket();
    });
  </script>

</body>
</html>
